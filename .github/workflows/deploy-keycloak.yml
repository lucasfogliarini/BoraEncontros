name: Deploy Keycloak to Azure Container App

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Keycloak
    runs-on: ubuntu-latest
    environment:
      name: 'Production'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_BORA_CREDS }}

    - name: Deploy Keycloak to Azure Container App
      uses: azure/container-apps-deploy-action@v2
      with:
        resourceGroup: rg-bora
        containerAppEnvironment: boraencontros-environment
        containerAppName: keycloak
        imageToDeploy: quay.io/keycloak/keycloak:latest
        ingress: external
        targetPort: 8080
        envVars: |
          KEYCLOAK_ADMIN=${{ secrets.KEYCLOAK_ADMIN_USERNAME }}
          KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
          #KC_DB=postgres
          #KC_DB_URL=jdbc:postgresql://${{ secrets.PG_HOST }}:5432/keycloak
          #KC_DB_USERNAME=${{ secrets.PG_USER }}
          #KC_DB_PASSWORD=${{ secrets.PG_PASSWORD }}
          #KC_HOSTNAME=${{ secrets.KEYCLOAK_HOSTNAME }}
        startupCommand: '["start"]'
